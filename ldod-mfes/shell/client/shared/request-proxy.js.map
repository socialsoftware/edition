{"version":3,"file":"request-proxy.js","sources":["../fetcher/src/request-proxy.js"],"sourcesContent":["/** @format */\n\nimport { getPartialStorage } from '@shared/store.js';\nimport { ldodEventPublisher } from '@shared/ldod-events.js';\nimport { navigateTo } from '@shared/router.js';\n\nconst HOST = window.process?.apiHost || 'http://localhost:8000/api';\nconst handleLoading = isLoading => ldodEventPublisher('loading', isLoading);\nconst handleLogout = () => ldodEventPublisher('logout');\nconst handleError = message => ldodEventPublisher('error', message || 'Something went wrong');\n\nfunction getOptions(method, token, contentType) {\n\tconst headers = new Headers({\n\t\tAuthorization: `Bearer ${token || ''}`,\n\t\t'Accept-Encoding': 'gzip',\n\t});\n\tif (contentType === mediaType.JSON) headers.set('Content-Type', contentType);\n\treturn { method, headers, token };\n}\n\nconst mediaType = Object.freeze({\n\tJSON: 'application/json',\n\tFORM_DATA: 'multipart/form-data',\n});\n\nclass RequestProxy {\n\tconstructor() {\n\t\tif (RequestProxy.instance) return RequestProxy.instance;\n\t\tRequestProxy.instance = this;\n\t}\n\n\tget storageToken() {\n\t\treturn getPartialStorage('ldod-store', ['token'])?.token;\n\t}\n\n\tasync fetchRequest(url, options) {\n\t\ttry {\n\t\t\tconst res = await fetch(url, options);\n\t\t\tconst resData = await res.json();\n\t\t\thandleLoading(false);\n\t\t\tif (!res.ok) {\n\t\t\t\tif (res.status === 401) handleLogout();\n\t\t\t\telse handleError(resData?.message);\n\t\t\t\treturn Promise.reject(resData || res);\n\t\t\t}\n\t\t\treturn resData;\n\t\t} catch (error) {\n\t\t\tconsole.error('FETCH ERROR: ', error?.stack ?? error);\n\t\t\thandleError();\n\t\t\tnavigateTo('/');\n\t\t\thandleLoading(false);\n\t\t}\n\t}\n\n\tasync request(method, { url, path, token, signal }, contentType, data) {\n\t\thandleLoading(true);\n\t\tconst accessToken = token ? token : this.storageToken;\n\t\tif (!accessToken) handleLogout();\n\t\tif (data && typeof data !== 'object') throw new Error('Data must be an Object');\n\t\tconst options = getOptions(method, accessToken, contentType);\n\t\tif (signal) options.signal = signal;\n\t\tif (data) options.body = data;\n\t\treturn await this.fetchRequest(url ?? HOST.concat(path), options);\n\t}\n\n\tasync get(request) {\n\t\treturn await this.request('GET', request, mediaType.JSON);\n\t}\n\n\tasync post(request, data) {\n\t\treturn await this.request('POST', request, mediaType.JSON, JSON.stringify(data));\n\t}\n\n\tasync upload(request, data) {\n\t\treturn await this.request('POST', request, mediaType.FORM_DATA, data);\n\t}\n}\n\nexport default Object.freeze(new RequestProxy());\n"],"names":["HOST","window","process","apiHost","handleLoading","isLoading","ldodEventPublisher","handleLogout","handleError","message","mediaType","Object","freeze","JSON","FORM_DATA","RequestProxy","constructor","instance","this","storageToken","getPartialStorage","token","async","url","options","res","fetch","resData","json","ok","status","Promise","reject","error","console","stack","navigateTo","method","path","signal","contentType","data","accessToken","Error","headers","Headers","Authorization","set","getOptions","body","fetchRequest","concat","request","stringify","requestProxy"],"mappings":"gKAMA,MAAMA,EAAOC,OAAOC,SAASC,SAAW,4BAClCC,EAAgBC,GAAaC,EAAmB,UAAWD,GAC3DE,EAAe,IAAMD,EAAmB,UACxCE,EAAcC,GAAWH,EAAmB,QAASG,GAAW,wBAWtE,MAAMC,EAAYC,OAAOC,OAAO,CAC/BC,KAAM,mBACNC,UAAW,wBAGZ,MAAMC,EACLC,cACC,GAAID,EAAaE,SAAU,OAAOF,EAAaE,SAC/CF,EAAaE,SAAWC,IACxB,CAEGC,mBACH,OAAOC,EAAkB,aAAc,CAAC,WAAWC,KACnD,CAEDC,mBAAmBC,EAAKC,GACvB,IACC,MAAMC,QAAYC,MAAMH,EAAKC,GACvBG,QAAgBF,EAAIG,OAE1B,OADAxB,GAAc,GACTqB,EAAII,GAKFF,GAJa,MAAfF,EAAIK,OAAgBvB,IACnBC,EAAYmB,GAASlB,SACnBsB,QAAQC,OAAOL,GAAWF,GAQlC,CALC,MAAOQ,GACRC,QAAQD,MAAM,gBAAiBA,GAAOE,OAASF,GAC/CzB,IACA4B,EAAW,KACXhC,GAAc,EACd,CACD,CAEDkB,cAAce,GAAQd,IAAEA,EAAGe,KAAEA,EAAIjB,MAAEA,EAAKkB,OAAEA,GAAUC,EAAaC,GAChErC,GAAc,GACd,MAAMsC,EAAcrB,GAAgBH,KAAKC,aAEzC,GADKuB,GAAanC,IACdkC,GAAwB,iBAATA,EAAmB,MAAM,IAAIE,MAAM,0BACtD,MAAMnB,EAhDR,SAAoBa,EAAQhB,EAAOmB,GAClC,MAAMI,EAAU,IAAIC,QAAQ,CAC3BC,cAAe,UAAUzB,GAAS,KAClC,kBAAmB,SAGpB,OADImB,IAAgB9B,EAAUG,MAAM+B,EAAQG,IAAI,eAAgBP,GACzD,CAAEH,SAAQO,UAASvB,QAC3B,CAyCkB2B,CAAWX,EAAQK,EAAaF,GAGhD,OAFID,IAAQf,EAAQe,OAASA,GACzBE,IAAMjB,EAAQyB,KAAOR,SACZvB,KAAKgC,aAAa3B,GAAOvB,EAAKmD,OAAOb,GAAOd,EACzD,CAEDF,UAAU8B,GACT,aAAalC,KAAKkC,QAAQ,MAAOA,EAAS1C,EAAUG,KACpD,CAEDS,WAAW8B,EAASX,GACnB,aAAavB,KAAKkC,QAAQ,OAAQA,EAAS1C,EAAUG,KAAMA,KAAKwC,UAAUZ,GAC1E,CAEDnB,aAAa8B,EAASX,GACrB,aAAavB,KAAKkC,QAAQ,OAAQA,EAAS1C,EAAUI,UAAW2B,EAChE,EAGF,IAAAa,EAAe3C,OAAOC,OAAO,IAAIG"}
{"version":3,"file":"fetcher.js","sources":["../fetcher/src/fetcher.js"],"sourcesContent":["/** @format */\n\nimport { getPartialStorage } from '@shared/store.js';\nimport { ldodEventPublisher } from '@shared/ldod-events.js';\nimport { navigateTo } from '@shared/router.js';\n\nconst HOST = window.process?.apiHost || 'http://localhost:8000/api';\n\nconst handleLoading = isLoading => ldodEventPublisher('loading', isLoading);\nconst handleLogout = () => ldodEventPublisher('logout');\nconst handleError = message => ldodEventPublisher('error', message || 'Something went wrong');\n\nconst getStorageToken = () => getPartialStorage('ldod-store', ['token'])?.token;\n\nconst fetchRequest = async (url, options) => {\n\ttry {\n\t\tconst res = await fetch(url, options);\n\t\tif (res.status === 401) {\n\t\t\thandleLogout();\n\t\t\treturn Promise.reject(res);\n\t\t}\n\t\tconst resData = await res.json();\n\t\tif (!res.ok) {\n\t\t\thandleError(resData?.message);\n\t\t\treturn Promise.reject(resData || res);\n\t\t}\n\t\treturn resData;\n\t} catch (error) {\n\t\tconsole.error('FETCH ERROR: ', error?.stack ?? error);\n\t\thandleError();\n\t\tnavigateTo('/');\n\t} finally {\n\t\thandleLoading(false);\n\t}\n};\n\nconst request = async (method, path, data, token, signal) => {\n\thandleLoading(true);\n\tconst options = {};\n\tconst accessToken = token ? token : getStorageToken();\n\tif (!accessToken) handleLogout();\n\n\tif (data && typeof data !== 'object') throw new Error('Data must be an Object');\n\toptions.headers = new Headers();\n\toptions.headers.append('Authorization', `Bearer ${accessToken || ''}`);\n\toptions.headers.append('Content-Type', 'application/json');\n\toptions.headers.append('Accept-Encoding', 'gzip');\n\n\tif (path.includes('restricted') || path.includes('admin'))\n\t\toptions.headers.append('Cache-Control', 'private');\n\n\toptions.method = method;\n\tif (signal) options.signal = signal;\n\tif (data) options.body = JSON.stringify(data);\n\treturn await fetchRequest(HOST.concat(path), options);\n};\n\nexport const fetcher = ['get', 'post', 'put', 'delete'].reduce((fetcher, method) => {\n\tfetcher[method] = (url, data = {}, token = undefined, signal = undefined) =>\n\t\trequest(method.toUpperCase(), url, data, token, signal);\n\treturn fetcher;\n}, {});\n\nexport const xmlFileFetcher = async ({\n\turl,\n\tbody,\n\tmethod = 'POST',\n\ttoken,\n\theaders = [],\n\tsignal,\n}) => {\n\thandleLoading(true);\n\tconst options = {};\n\tconst accessToken = token ? token : getStorageToken();\n\toptions.headers = new Headers();\n\taccessToken && options.headers.set('Authorization', accessToken);\n\theaders.forEach(header =>\n\t\tObject.entries(header).forEach(([key, value]) => {\n\t\t\toptions.headers.set(key, value);\n\t\t})\n\t);\n\toptions.method = method;\n\tif (signal) options.signal = signal;\n\tif (body) options.body = body;\n\treturn await fetchRequest(HOST.concat(url), options);\n};\n"],"names":["HOST","window","process","apiHost","handleLoading","isLoading","ldodEventPublisher","handleLogout","handleError","message","getStorageToken","getPartialStorage","token","fetchRequest","async","url","options","res","fetch","status","Promise","reject","resData","json","ok","error","console","stack","navigateTo","fetcher","reduce","method","data","signal","path","accessToken","Error","headers","Headers","append","includes","body","JSON","stringify","concat","request","toUpperCase","xmlFileFetcher","set","forEach","header","Object","entries","key","value"],"mappings":"gKAMA,MAAMA,EAAOC,OAAOC,SAASC,SAAW,4BAElCC,EAAgBC,GAAaC,EAAmB,UAAWD,GAC3DE,EAAe,IAAMD,EAAmB,UACxCE,EAAcC,GAAWH,EAAmB,QAASG,GAAW,wBAEhEC,EAAkB,IAAMC,EAAkB,aAAc,CAAC,WAAWC,MAEpEC,EAAeC,MAAOC,EAAKC,KAChC,IACC,MAAMC,QAAYC,MAAMH,EAAKC,GAC7B,GAAmB,MAAfC,EAAIE,OAEP,OADAZ,IACOa,QAAQC,OAAOJ,GAEvB,MAAMK,QAAgBL,EAAIM,OAC1B,OAAKN,EAAIO,GAIFF,GAHNd,EAAYc,GAASb,SACdW,QAAQC,OAAOC,GAAWL,GASlC,CANC,MAAOQ,GACRC,QAAQD,MAAM,gBAAiBA,GAAOE,OAASF,GAC/CjB,IACAoB,EAAW,IACb,CAAW,QACTxB,GAAc,EACd,GAwBWyB,EAAU,CAAC,MAAO,OAAQ,MAAO,UAAUC,QAAO,CAACD,EAASE,KACxEF,EAAQE,GAAU,CAAChB,EAAKiB,EAAO,CAAA,EAAIpB,EAAmBqB,IAtBvCnB,OAAOiB,EAAQG,EAAMF,EAAMpB,EAAOqB,KACjD7B,GAAc,GACd,MAAMY,EAAU,CAAA,EACVmB,EAAcvB,GAAgBF,IAGpC,GAFKyB,GAAa5B,IAEdyB,GAAwB,iBAATA,EAAmB,MAAM,IAAII,MAAM,0BAYtD,OAXApB,EAAQqB,QAAU,IAAIC,QACtBtB,EAAQqB,QAAQE,OAAO,gBAAiB,UAAUJ,GAAe,MACjEnB,EAAQqB,QAAQE,OAAO,eAAgB,oBACvCvB,EAAQqB,QAAQE,OAAO,kBAAmB,SAEtCL,EAAKM,SAAS,eAAiBN,EAAKM,SAAS,WAChDxB,EAAQqB,QAAQE,OAAO,gBAAiB,WAEzCvB,EAAQe,OAASA,EACbE,IAAQjB,EAAQiB,OAASA,GACzBD,IAAMhB,EAAQyB,KAAOC,KAAKC,UAAUX,UAC3BnB,EAAab,EAAK4C,OAAOV,GAAOlB,EAAQ,EAKpD6B,CAAQd,EAAOe,cAAe/B,EAAKiB,EAAMpB,EAAOqB,GAC1CJ,IACL,IAEUkB,EAAiBjC,OAC7BC,MACA0B,OACAV,SAAS,OACTnB,QACAyB,UAAU,GACVJ,aAEA7B,GAAc,GACd,MAAMY,EAAU,CAAA,EACVmB,EAAcvB,GAAgBF,IAWpC,OAVAM,EAAQqB,QAAU,IAAIC,QACtBH,GAAenB,EAAQqB,QAAQW,IAAI,gBAAiBb,GACpDE,EAAQY,SAAQC,GACfC,OAAOC,QAAQF,GAAQD,SAAQ,EAAEI,EAAKC,MACrCtC,EAAQqB,QAAQW,IAAIK,EAAKC,EAAM,MAGjCtC,EAAQe,OAASA,EACbE,IAAQjB,EAAQiB,OAASA,GACzBQ,IAAMzB,EAAQyB,KAAOA,SACZ5B,EAAab,EAAK4C,OAAO7B,GAAMC,EAAQ"}
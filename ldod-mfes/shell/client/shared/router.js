import{ldodEventSubscriber as t,ldodEventPublisher as e}from"@shared/ldod-events.js";const s=/^\/[^/]*/,i=t=>"/"===t,h=t=>{if(t&&t.trim())return t.startsWith("/")?t:`/${t}`},a=t=>{if(t&&t.trim())return i(t)||!t.endsWith("/")?t:t.substring(0,t.length-1)};class r extends HTMLElement{constructor(){super(),this.routes={},this.shadow&&this.attachShadow({mode:"open"})}static get observedAttributes(){return["language"]}get shadow(){return this.hasAttribute("shadow")}get self(){return this.shadow?this.shadowRoot:this}get location(){return a(location.pathname)}get route(){return h(a(this.getAttribute("route")))||""}get base(){return h(a(this.getAttribute("base")))||""}get routerPathname(){return a(`/${this.base}${this.route}`)?.replace(/\/\/+/g,"/")}get outlet(){let t=this.self.querySelector("ldod-outlet");return t||(t=document.createElement("ldod-outlet")),t.id=`${this.id}-outlet`,t}get language(){return this.getAttribute("language")}set language(t){this.setAttribute("language",t)}getFullPath=t=>a(`/${this.base}/${t??""}`.replace(/\/\/+/g,"/"));normalizePath=t=>i(this.routerPathname)?t:(t=>{if(t&&t.trim())return t.endsWith("/")?t:`${t}/`})(t).replace(`${this.routerPathname}/`,"/").replace(/\/\/+/g,"/");isPathActive=t=>{if(!this.active)return!1;let e=s.exec(this.normalizePath(t)).at(0);return a(this.normalizePath(this.active.path))===e};isFromThisRouter=t=>{if(!this.route)return!0;return(this.base?t.replace(this.base,""):t).startsWith(this.route)};async connectedCallback(){if(this.addEventListeners(),!this.id)throw new Error("Each router must have an unique ID");this.self.append(this.outlet),this.processRoutes()}processRoutes(t=this.routes){this.routes=Object.entries(t).reduce(((t,[e,s])=>(t[a(`/${this.base}/${this.route}/${e}`.replace(/\/\/+/g,"/"))]=s,t)),{}),this.navigate()}attributeChangedCallback(t,e,s){"language"===t&&e&&e!==s&&this.handleLanguageChange(s)}handleLanguageChange(t){this.self.querySelectorAll("[language]").forEach((e=>e.setAttribute("language",t)))}disconnectedCallback(){this.unsubURL(),window.removeEventListener("popstate",this.handlePopstate)}addEventListeners(){this.unsubURL=t("url-changed",this.handleURLChanged),window.addEventListener("popstate",this.handlePopstate)}navigate=(t=this.location,e={})=>{this.isPathActive(t)||(this.location!==t&&history.pushState(e,void 0,t),this.render())};handleURLChanged=({payload:{path:t,state:e}})=>{t&&this.isFromThisRouter(t)&&this.navigate(this.getFullPath(t),e)};handlePopstate=()=>this.isFromThisRouter(this.location)&&this.navigate(this.location);async render(){let t=await this.getRoute();e("loading",!0),await this.appendMFE(t),e("loading",!1)}isARouteMatch=t=>{const e=t.split("/"),s=this.location.split("/");return e.every(((t,e)=>!!t.startsWith(":")||s[e]===t))};async getRoute(){let t=this.location===this.routerPathname?this.index:Object.entries(this.routes).filter((([t,e])=>this.isARouteMatch(t)&&e)).sort((([t],[e])=>{const s=this.location.split("/").length,i=t?.split("/").length,h=e?.split("/").length;return+(h===s)-+(i===s)}))[0]?.[1]??this.fallback;return"function"==typeof t&&this.updateRoutingParameters(await t()),t}updateRoutingParameters=t=>{const e=t.path.split("/").reduce(((t,e,s)=>{if(e.startsWith(":")){const i=e.replace(":",""),a=h(this.location.replace(this.routerPathname,"")).split("/")[s];return{...t,[i]:a}}return t}),{...history.state});e&&history.replaceState(e,"")};async appendMFE(t){t&&(this.active&&await this.removeMFE(),this.active=await t(),await this.active.mount(this.language,`#${this.outlet.id}`))}async removeMFE(){await(this.active?.unMount()),this.outlet.innerHTML=""}}customElements.define("ldod-router",r);class n extends HTMLAnchorElement{get to(){const t=this.getAttribute("to");return"string"==typeof t?t.trim():""}get mfePath(){return"/"===this.to?this.to:this.to?.split("/")[1]}get hasTo(){return this.hasAttribute("to")}get hasContent(){return this.hasAttribute("content")}get publishedMfes(){return[...window.mfes??[],"/"]}connectedCallback(){this.checkIfMfesIsPublished(),this.target?this.href=this.to:this.addEventListener("click",this.onclick)}onclick(t){t.preventDefault(),this.emitURLEvent()}emitURLEvent(){this.to&&e("url-changed",{path:this.to})}checkIfMfesIsPublished=()=>{if(!this.target&&this.hasTo&&!this.publishedMfes.includes(this.mfePath)){if(this.hasContent)return this.setAttribute("to","");this.style.display="none"}}}customElements.define("nav-to",n,{extends:"a"});class o extends HTMLAnchorElement{get to(){const t=this.getAttribute("to");return"string"==typeof t?t.trim():""}get mfePath(){return"/"===this.to?this.to:this.to?.split("/")[1]}get hasTo(){return this.hasAttribute("to")}get hasContent(){return this.hasAttribute("content")}get publishedMfes(){return[...window.mfes??[],"/"]}static get observedAttributes(){return["to"]}attributeChangedCallback(t,e,s){this.attributeChanged[t](e,s)}attributeChanged={to:()=>!this.target&&this.hasTo&&this.interceptBehavior()};connectedCallback(){this.href||(!this.target&&this.hasTo&&this.interceptBehavior(),this.target&&(this.handleMfePublishState(),this.hasTo&&(this.href=`/ldod-mfes${this.to}`)))}interceptBehavior=()=>{this.handleMfePublishState(),this.addEventListener("click",this.onclick)};handleMfePublishState=()=>{this.isMfePublished()||(this.hasContent?this.removeToAttr():this.hide())};onclick(t){t.preventDefault(),this.emitURLEvent()}emitURLEvent(){this.to&&e("url-changed",{path:this.to})}isMfePublished=()=>this.publishedMfes.includes(this.mfePath);hide=()=>{this.style.display="none"};removeToAttr=()=>this.removeAttribute("to")}customElements.define("nav-to-new",o,{extends:"a"});const u=(t,s)=>{e("url-changed",{path:t,state:s})};export{u as navigateTo};
//# sourceMappingURL=router.js.map
